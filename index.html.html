<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar de Contas</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg:#0a0c10;--surface:#111318;--surface2:#181c24;--border:rgba(255,255,255,0.07);
    --accent:#00e5a0;--accent2:#ff6b35;--accent3:#4d9fff;--text:#e8eaf0;--muted:#5a6070;
    --hot:#ff4757;--warm:#ffa502;--cold:#4d9fff;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,160,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,160,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
  body::after{content:'';position:fixed;top:-20%;right:-10%;width:600px;height:600px;background:radial-gradient(circle,rgba(0,229,160,0.06) 0%,transparent 70%);pointer-events:none;z-index:0}
  .app{position:relative;z-index:1}

  /* SETUP SCREEN */
  .setup-screen{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px}
  .setup-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:36px;width:100%;max-width:520px}
  .setup-logo{display:flex;align-items:center;gap:12px;margin-bottom:28px}
  .setup-logo-icon{width:40px;height:40px;border:1.5px solid var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative}
  .setup-logo-icon::before{content:'';width:12px;height:12px;background:var(--accent);border-radius:50%;animation:pulse 2s ease-in-out infinite}
  .setup-logo-icon::after{content:'';position:absolute;width:22px;height:22px;border:1.5px solid rgba(0,229,160,0.3);border-radius:50%;animation:ripple 2s ease-out infinite}
  .setup-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800}
  .setup-subtitle{color:var(--muted);font-size:13px;margin-bottom:28px;line-height:1.6}
  .setup-steps{display:flex;flex-direction:column;gap:20px;margin-bottom:28px}
  .setup-step{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px}
  .step-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .step-num{width:24px;height:24px;background:var(--accent);color:#0a0c10;border-radius:6px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .step-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:600}
  .step-desc{font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:10px}
  .step-desc a{color:var(--accent)}
  .setup-mode-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
  .mode-btn{padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all .2s;text-align:center}
  .mode-btn:hover{border-color:rgba(0,229,160,0.3)}
  .mode-btn.selected{background:rgba(0,229,160,0.08);border-color:var(--accent);color:var(--accent)}
  .mode-icon{font-size:24px;display:block;margin-bottom:6px}

  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;padding:20px 32px;border-bottom:1px solid var(--border);background:rgba(10,12,16,0.8);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:36px;height:36px;border:1.5px solid var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative}
  .logo-icon::before{content:'';width:10px;height:10px;background:var(--accent);border-radius:50%;animation:pulse 2s ease-in-out infinite}
  .logo-icon::after{content:'';position:absolute;width:20px;height:20px;border:1.5px solid rgba(0,229,160,0.3);border-radius:50%;animation:ripple 2s ease-out infinite}
  @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.15);opacity:.8}}
  @keyframes ripple{0%{transform:scale(.5);opacity:.8}100%{transform:scale(1.5);opacity:0}}
  .logo h1{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;letter-spacing:-.3px}
  .logo span{font-weight:400;color:var(--muted)}
  .header-right{display:flex;align-items:center;gap:10px}
  .live-badge{display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);border-radius:20px;padding:4px 12px}
  .live-dot{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:blink 1.5s ease-in-out infinite}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
  .role-badge{font-family:'DM Mono',monospace;font-size:10px;padding:4px 10px;border-radius:20px;border:1px solid}
  .role-badge.admin{color:var(--warm);border-color:rgba(255,165,2,0.3);background:rgba(255,165,2,0.08)}
  .role-badge.viewer{color:var(--cold);border-color:rgba(77,159,255,0.3);background:rgba(77,159,255,0.08)}
  .btn-excel{background:transparent;color:var(--accent);border:1px solid rgba(0,229,160,0.3);padding:8px 16px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
  .btn-excel:hover{background:rgba(0,229,160,0.08)}
  .btn-import{background:transparent;color:var(--accent3);border:1px solid rgba(77,159,255,0.3);padding:8px 16px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
  .btn-import:hover{background:rgba(77,159,255,0.08)}
  .btn-add{background:var(--accent);color:#0a0c10;border:none;padding:8px 18px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s}
  .btn-add:hover{opacity:.85;transform:translateY(-1px)}

  .sync-indicator{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);display:flex;align-items:center;gap:5px}
  .sync-indicator.syncing{color:var(--warm)}
  .sync-indicator.synced{color:var(--accent)}
  .sync-indicator.error{color:var(--hot)}

  /* STATS */
  .stats-bar{display:flex;gap:1px;padding:0 32px;background:var(--border);border-bottom:1px solid var(--border)}
  .stat-item{flex:1;padding:16px 20px;background:var(--surface);display:flex;align-items:center;gap:12px}
  .stat-icon{font-size:18px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--surface2)}
  .stat-val{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;line-height:1}
  .stat-label{font-size:11px;color:var(--muted);margin-top:2px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.5px}

  /* MAIN */
  .main{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 120px)}
  .sidebar{border-right:1px solid var(--border);padding:24px 0;background:var(--surface)}
  .sidebar-section{padding:0 20px;margin-bottom:28px}
  .sidebar-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
  .filter-btn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:9px 12px;background:transparent;border:1px solid transparent;border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all .15s;text-align:left;margin-bottom:2px}
  .filter-btn:hover{background:var(--surface2)}
  .filter-btn.active{background:rgba(0,229,160,0.08);border-color:rgba(0,229,160,0.2);color:var(--accent)}
  .filter-count{font-family:'DM Mono',monospace;font-size:11px;background:var(--surface2);padding:2px 7px;border-radius:10px;color:var(--muted)}
  .filter-btn.active .filter-count{background:rgba(0,229,160,0.15);color:var(--accent)}
  .priority-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:8px}
  .search-box{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
  .search-box:focus{border-color:rgba(0,229,160,.4)}
  .search-box::placeholder{color:var(--muted)}

  /* CONTENT */
  .content{padding:28px 32px}
  .content-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
  .content-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:600}
  .sort-select{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 12px;border-radius:8px;font-size:12px;font-family:'DM Sans',sans-serif;outline:none;cursor:pointer}
  .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}

  /* CARDS */
  .account-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;transition:all .2s;position:relative;overflow:hidden;animation:fadeIn .4s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .account-card:hover{border-color:rgba(0,229,160,0.25);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3)}
  .account-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:14px 14px 0 0}
  .account-card.hot::before{background:var(--hot)}
  .account-card.warm::before{background:var(--warm)}
  .account-card.cold::before{background:var(--cold)}
  .card-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px}
  .company-info{display:flex;align-items:center;gap:12px}
  .company-avatar{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;font-size:16px;flex-shrink:0}
  .company-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:600;margin-bottom:2px}
  .company-segment{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace}
  .priority-badge{font-size:10px;font-family:'DM Mono',monospace;padding:3px 8px;border-radius:20px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0}
  .badge-hot{background:rgba(255,71,87,.12);color:var(--hot);border:1px solid rgba(255,71,87,.3)}
  .badge-warm{background:rgba(255,165,2,.12);color:var(--warm);border:1px solid rgba(255,165,2,.3)}
  .badge-cold{background:rgba(77,159,255,.12);color:var(--cold);border:1px solid rgba(77,159,255,.3)}
  .signals{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
  .signal-item{display:flex;align-items:flex-start;gap:8px;padding:8px 10px;background:var(--surface2);border-radius:8px;border-left:2px solid transparent}
  .signal-item.expansion{border-left-color:var(--accent)}
  .signal-item.news{border-left-color:var(--accent3)}
  .signal-item.competitor{border-left-color:var(--accent2)}
  .signal-icon{font-size:13px;flex-shrink:0;margin-top:1px}
  .signal-text{font-size:12px;color:var(--text);line-height:1.4;flex:1}
  .signal-time{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;flex-shrink:0;margin-top:2px}
  .card-footer{display:flex;align-items:center;justify-content:space-between;padding-top:12px;border-top:1px solid var(--border)}
  .signal-count{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace}
  .signal-count span{color:var(--accent);font-weight:500}
  .card-actions{display:flex;gap:6px}
  .btn-action{font-size:11px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:6px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
  .btn-action:hover{border-color:var(--accent);color:var(--accent)}
  .btn-ai{font-size:11px;background:linear-gradient(135deg,rgba(0,229,160,0.1),rgba(77,159,255,0.1));border:1px solid rgba(0,229,160,0.25);color:var(--accent);padding:5px 12px;border-radius:6px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;display:flex;align-items:center;gap:4px}
  .btn-ai:hover{background:rgba(0,229,160,0.18)}
  .btn-ai.loading{opacity:.6;cursor:not-allowed}

  /* AI PANEL */
  .ai-panel{display:none;margin-top:12px;padding:14px;background:linear-gradient(135deg,rgba(0,229,160,0.05),rgba(77,159,255,0.05));border:1px solid rgba(0,229,160,0.2);border-radius:10px}
  .ai-panel.visible{display:block;animation:fadeIn .3s ease}
  .ai-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .ai-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px}
  .ai-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 4px}
  .ai-text{font-size:12px;line-height:1.7;color:var(--text);white-space:pre-wrap}
  .ai-typing::after{content:'â–‹';animation:blink .8s infinite;color:var(--accent)}

  /* MODALS */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center}
  .modal-overlay.open{display:flex}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;width:480px;max-width:90vw;max-height:85vh;overflow-y:auto;animation:slideUp .25s ease}
  @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
  .modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700}
  .modal-close{background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
  .form-group{margin-bottom:16px}
  .form-label{display:block;font-size:11px;font-family:'DM Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
  .form-input,.form-select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
  .form-input:focus,.form-select:focus{border-color:rgba(0,229,160,.4)}
  .form-select option{background:var(--surface2)}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn-submit{width:100%;background:var(--accent);color:#0a0c10;border:none;padding:12px;border-radius:10px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:8px}
  .btn-submit:hover{opacity:.85}
  .notice-box{border-radius:10px;padding:14px;margin-bottom:16px;font-size:12px;line-height:1.6}
  .notice-warn{background:rgba(255,165,2,0.08);border:1px solid rgba(255,165,2,0.25);color:var(--warm)}
  .notice-info{background:rgba(0,229,160,0.06);border:1px solid rgba(0,229,160,0.2);color:var(--accent)}
  .notice-box a{color:var(--accent)}
  .notice-box strong{color:var(--text)}
  .code-block{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);white-space:pre;overflow-x:auto;margin:8px 0}

  /* IMPORT */
  .drop-zone{border:2px dashed rgba(77,159,255,0.3);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px}
  .drop-zone:hover,.drop-zone.drag-over{border-color:var(--accent3);background:rgba(77,159,255,0.05)}
  .drop-zone-icon{font-size:32px;margin-bottom:10px}
  .drop-zone-text{font-size:13px;color:var(--muted);line-height:1.6}
  .drop-zone-text strong{color:var(--accent3)}
  .template-box{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px}
  .template-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
  .template-cols{display:flex;gap:6px;flex-wrap:wrap}
  .col-tag{background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);color:var(--accent);font-family:'DM Mono',monospace;font-size:10px;padding:3px 8px;border-radius:6px}
  .col-tag.optional{background:rgba(255,255,255,0.04);border-color:var(--border);color:var(--muted)}
  .preview-table{width:100%;border-collapse:collapse;font-size:11px;margin-bottom:16px;max-height:180px;overflow-y:auto;display:block}
  .preview-table th{background:var(--surface2);color:var(--muted);font-family:'DM Mono',monospace;text-transform:uppercase;font-size:10px;padding:7px 10px;text-align:left;border-bottom:1px solid var(--border);position:sticky;top:0}
  .preview-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text)}
  .import-summary{display:flex;gap:10px;margin-bottom:16px}
  .import-stat{flex:1;background:var(--surface2);border-radius:8px;padding:10px 12px;text-align:center}
  .import-stat-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;color:var(--accent)}
  .import-stat-label{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px}
  .btn-download-template{width:100%;background:transparent;color:var(--accent3);border:1px dashed rgba(77,159,255,0.3);padding:9px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;transition:all .2s;margin-bottom:12px}

  .empty-state{text-align:center;padding:60px 20px;color:var(--muted);display:none}
  .empty-state.visible{display:block}
  .empty-state-icon{font-size:40px;margin-bottom:12px}
  .toast{position:fixed;bottom:24px;right:24px;background:var(--accent);color:#0a0c10;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;z-index:999;transform:translateY(80px);transition:transform .3s ease;font-family:'DM Sans',sans-serif}
  .toast.show{transform:translateY(0)}
  ::-webkit-scrollbar{width:4px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>
<div class="app">

  <!-- SETUP SCREEN -->
  <div class="setup-screen" id="setup-screen">
    <div class="setup-box">
      <div class="setup-logo">
        <div class="setup-logo-icon"></div>
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800">Radar de Contas</div>
          <div style="font-size:12px;color:var(--muted)">ConfiguraÃ§Ã£o inicial</div>
        </div>
      </div>

      <div id="setup-step-choose">
        <p class="setup-subtitle">Escolha como vocÃª vai usar o app:</p>
        <div class="setup-mode-btns">
          <button class="mode-btn" id="btn-mode-admin" onclick="selectMode('admin')">
            <span class="mode-icon">ğŸ‘‘</span>
            <strong>Sou o Admin</strong><br>
            <span style="font-size:11px;color:var(--muted)">Gerencio e edito as contas</span>
          </button>
          <button class="mode-btn" id="btn-mode-viewer" onclick="selectMode('viewer')">
            <span class="mode-icon">ğŸ‘ï¸</span>
            <strong>Sou Visualizador</strong><br>
            <span style="font-size:11px;color:var(--muted)">SÃ³ visualizo as contas</span>
          </button>
        </div>
        <div id="setup-fields"></div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon"></div>
      <h1>Radar <span>de Contas</span></h1>
    </div>
    <div class="header-right">
      <div class="sync-indicator" id="sync-indicator">â¬¤ conectando...</div>
      <div class="live-badge"><div class="live-dot"></div>MONITORANDO</div>
      <span class="role-badge" id="role-badge">admin</span>
      <button class="btn-import" id="btn-import-header" onclick="openImportModal()">ğŸ“¥ Importar</button>
      <button class="btn-excel" onclick="exportToExcel()">ğŸ“Š Excel</button>
      <button class="btn-add" id="btn-add-header" onclick="openModal()">+ Nova Conta</button>
    </div>
  </header>

  <div class="stats-bar">
    <div class="stat-item"><div class="stat-icon">ğŸ¢</div><div><div class="stat-val" id="total-count">0</div><div class="stat-label">Contas</div></div></div>
    <div class="stat-item"><div class="stat-icon">ğŸ”¥</div><div><div class="stat-val" id="hot-count" style="color:var(--hot)">0</div><div class="stat-label">Quentes</div></div></div>
    <div class="stat-item"><div class="stat-icon">ğŸ“¡</div><div><div class="stat-val" id="signal-count" style="color:var(--accent)">0</div><div class="stat-label">Sinais hoje</div></div></div>
    <div class="stat-item"><div class="stat-icon">âš¡</div><div><div class="stat-val" id="opp-count" style="color:var(--warm)">0</div><div class="stat-label">Oportunidades</div></div></div>
  </div>

  <div class="main">
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-label">Buscar</div>
        <input class="search-box" type="text" placeholder="Buscar empresa..." id="search-input" oninput="filterCards()">
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Prioridade</div>
        <button class="filter-btn active" onclick="setFilter('all',this)">Todas as contas <span class="filter-count" id="count-all">0</span></button>
        <button class="filter-btn" onclick="setFilter('hot',this)"><span><span class="priority-dot" style="background:var(--hot)"></span>Quente</span><span class="filter-count" id="count-hot">0</span></button>
        <button class="filter-btn" onclick="setFilter('warm',this)"><span><span class="priority-dot" style="background:var(--warm)"></span>Morno</span><span class="filter-count" id="count-warm">0</span></button>
        <button class="filter-btn" onclick="setFilter('cold',this)"><span><span class="priority-dot" style="background:var(--cold)"></span>Frio</span><span class="filter-count" id="count-cold">0</span></button>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Sinais</div>
        <button class="filter-btn" onclick="setSignalFilter('expansion',this)">ğŸ—ï¸ ExpansÃ£o de lojas</button>
        <button class="filter-btn" onclick="setSignalFilter('news',this)">ğŸ“° NotÃ­cias e mÃ­dia</button>
        <button class="filter-btn" onclick="setSignalFilter('competitor',this)">âš”ï¸ Concorrentes</button>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Segmento</div>
        <button class="filter-btn" onclick="setSegFilter('all',this)">Todos</button>
        <button class="filter-btn" onclick="setSegFilter('Supermercados',this)">Supermercados</button>
        <button class="filter-btn" onclick="setSegFilter('FarmÃ¡cias',this)">FarmÃ¡cias</button>
        <button class="filter-btn" onclick="setSegFilter('Moda',this)">Moda</button>
        <button class="filter-btn" onclick="setSegFilter('EletrÃ´nicos',this)">EletrÃ´nicos</button>
        <button class="filter-btn" onclick="setSegFilter('Home Center',this)">Home Center</button>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">ConfiguraÃ§Ãµes</div>
        <button class="filter-btn" onclick="openApiKeyModal()" style="color:var(--accent)">ğŸ”‘ Chave API Claude</button>
        <button class="filter-btn" onclick="resetSetup()" style="color:var(--muted)">âš™ï¸ Reconfigurar banco</button>
      </div>
    </aside>

    <main class="content">
      <div class="content-header">
        <div class="content-title" id="section-title">Todas as Contas</div>
        <select class="sort-select" onchange="sortCards(this.value)">
          <option value="priority">Ordenar: Prioridade</option>
          <option value="name">Ordenar: Nome A-Z</option>
          <option value="signals">Ordenar: Mais sinais</option>
          <option value="recent">Ordenar: Mais recente</option>
        </select>
      </div>
      <div class="cards-grid" id="cards-grid"></div>
      <div class="empty-state" id="empty-state">
        <div class="empty-state-icon">ğŸ“¡</div>
        <p>Nenhuma conta ainda. Adicione a primeira!</p>
      </div>
    </main>
  </div>
</div>

<!-- MODAL ADD/SIGNAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModalOnOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Nova Conta</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">Nome da empresa *</label>
      <div style="display:flex;gap:8px">
        <input class="form-input" id="f-name" placeholder="Ex: Grupo PÃ£o de AÃ§Ãºcar" style="flex:1">
        <button id="btn-autofill" onclick="autofillWithAI()" style="background:linear-gradient(135deg,rgba(0,229,160,0.15),rgba(77,159,255,0.15));border:1px solid rgba(0,229,160,0.3);color:var(--accent);padding:0 14px;border-radius:8px;cursor:pointer;font-size:13px;white-space:nowrap;transition:all .2s;flex-shrink:0">âœ¨ IA</button>
      </div>
    </div>
    <div id="autofill-status" style="display:none;margin-bottom:12px;padding:10px 14px;background:linear-gradient(135deg,rgba(0,229,160,0.07),rgba(77,159,255,0.07));border:1px solid rgba(0,229,160,0.2);border-radius:8px;font-size:12px;color:var(--accent);align-items:center;gap:8px">
      <span id="autofill-status-text">ğŸ” Pesquisando...</span>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Segmento</label>
        <select class="form-select" id="f-segment">
          <option value="">Selecione...</option>
          <option>Supermercados</option><option>FarmÃ¡cias</option><option>Moda</option><option>EletrÃ´nicos</option><option>Home Center</option><option>Outros</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Prioridade</label>
        <select class="form-select" id="f-priority"><option value="cold">ğŸ”µ Frio</option><option value="warm">ğŸŸ¡ Morno</option><option value="hot">ğŸ”´ Quente</option></select>
      </div>
    </div>
    <div class="form-group"><label class="form-label">NÂº de lojas</label><input class="form-input" id="f-stores" type="number" placeholder="Preenchido automaticamente pela IA"></div>
    <div class="form-group"><label class="form-label">Sinal inicial</label><input class="form-input" id="f-signal-text" placeholder="Preenchido automaticamente pela IA"></div>
    <div class="form-group"><label class="form-label">Tipo do sinal</label>
      <select class="form-select" id="f-signal-type"><option value="expansion">ğŸ—ï¸ ExpansÃ£o de lojas</option><option value="news">ğŸ“° NotÃ­cia / MÃ­dia</option><option value="competitor">âš”ï¸ Movimento de concorrente</option></select>
    </div>
    <button class="btn-submit" onclick="addAccount()">Adicionar ao Radar</button>
  </div>
</div>

<!-- MODAL IMPORT -->
<div class="modal-overlay" id="import-overlay" onclick="closeImportOnOverlay(event)">
  <div class="modal" style="max-width:540px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¥ Importar Contas em Massa</div>
      <button class="modal-close" onclick="closeImportModal()">âœ•</button>
    </div>
    <div id="import-step-1">
      <div class="template-box">
        <div class="template-label">Colunas esperadas</div>
        <div class="template-cols">
          <span class="col-tag">Nome</span><span class="col-tag">Segmento</span><span class="col-tag">Prioridade</span>
          <span class="col-tag optional">Lojas</span><span class="col-tag optional">Sinal</span><span class="col-tag optional">Tipo Sinal</span>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:10px;line-height:1.6">
          <strong style="color:var(--text)">Prioridade:</strong> quente / morno / frio &nbsp;|&nbsp;
          <strong style="color:var(--text)">Tipo Sinal:</strong> expansÃ£o / notÃ­cia / concorrente
        </div>
      </div>
      <button class="btn-download-template" onclick="downloadTemplate()">â¬‡ï¸ Baixar planilha modelo</button>
      <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <div class="drop-zone-icon">ğŸ“‚</div>
        <div class="drop-zone-text"><strong>Clique para selecionar</strong> ou arraste aqui<br>Aceita <strong>.xlsx</strong>, <strong>.xls</strong> ou <strong>.csv</strong></div>
      </div>
      <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFile(event)">
    </div>
    <div id="import-step-2" style="display:none">
      <div class="import-summary" id="import-summary"></div>
      <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">PrÃ©-visualizaÃ§Ã£o</div>
      <table class="preview-table" id="preview-table"></table>
      <button class="btn-submit" onclick="confirmImport()">âœ… Confirmar ImportaÃ§Ã£o</button>
      <button style="width:100%;background:transparent;border:1px solid var(--border);color:var(--muted);padding:9px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;margin-top:8px" onclick="resetImport()">â† Voltar</button>
    </div>
  </div>
</div>

<!-- MODAL API KEY -->
<div class="modal-overlay" id="apikey-overlay" onclick="closeApiKeyOnOverlay(event)">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div class="modal-title">ğŸ”‘ Chave API Claude</div>
      <button class="modal-close" onclick="closeApiKeyModal()">âœ•</button>
    </div>
    <div class="notice-box notice-warn">
      Obtenha sua chave gratuitamente em <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>.<br>
      Salva apenas localmente no seu navegador.
    </div>
    <div class="form-group"><label class="form-label">Chave API (sk-ant-...)</label><input class="form-input" id="f-apikey" type="password" placeholder="sk-ant-api03-..."></div>
    <button class="btn-submit" onclick="saveApiKey()">Salvar Chave</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” preenchida na tela de setup
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let SUPABASE_URL = localStorage.getItem('sb-url') || '';
let SUPABASE_KEY = localStorage.getItem('sb-key') || '';
let USER_ROLE = localStorage.getItem('user-role') || ''; // 'admin' | 'viewer'

const COLORS=[['#00e5a0','#0a2a1e'],['#4d9fff','#0a1a2e'],['#ff6b35','#2e1a0a'],['#a855f7','#1e0a2e'],['#f59e0b','#2e1e0a'],['#ec4899','#2e0a1e'],['#10b981','#0a2e1e'],['#6366f1','#0a0e2e']];
let accounts=[];
let currentFilter='all',currentSignalFilter=null,currentSegFilter='all',currentSort='priority',searchQuery='';
let syncInterval=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectMode(mode) {
  document.getElementById('btn-mode-admin').classList.toggle('selected', mode==='admin');
  document.getElementById('btn-mode-viewer').classList.toggle('selected', mode==='viewer');

  const fields = document.getElementById('setup-fields');
  if(mode==='admin') {
    fields.innerHTML = `
      <div class="setup-steps">
        <div class="setup-step">
          <div class="step-header"><div class="step-num">1</div><div class="step-title">Crie seu banco Supabase gratuito</div></div>
          <div class="step-desc">
            Acesse <a href="https://supabase.com" target="_blank">supabase.com</a> â†’ New Project â†’ crie um projeto gratuito.<br>
            Depois vÃ¡ em <strong>SQL Editor</strong> e execute este comando:
          </div>
          <div class="code-block">CREATE TABLE accounts (
  id TEXT PRIMARY KEY,
  data JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);</div>
          <div class="step-desc" style="margin-top:8px">Depois vÃ¡ em <strong>Settings â†’ API</strong> e copie a <strong>Project URL</strong> e a chave <strong>anon public</strong>.</div>
        </div>
        <div class="setup-step">
          <div class="step-header"><div class="step-num">2</div><div class="step-title">Cole as credenciais abaixo</div></div>
          <div class="form-group" style="margin-bottom:12px"><label class="form-label">Project URL</label><input class="form-input" id="setup-url" placeholder="https://xxxx.supabase.co"></div>
          <div class="form-group" style="margin-bottom:0"><label class="form-label">Anon Key</label><input class="form-input" id="setup-key" placeholder="eyJhbGciOiJIUzI1NiIs..."></div>
        </div>
      </div>
      <button class="btn-submit" onclick="saveSetup('admin')" style="margin-top:0">Entrar como Admin ğŸ‘‘</button>`;
  } else {
    fields.innerHTML = `
      <div class="setup-steps">
        <div class="setup-step">
          <div class="step-header"><div class="step-num">1</div><div class="step-title">PeÃ§a as credenciais ao admin</div></div>
          <div class="step-desc">Solicite ao administrador do Radar a <strong>Project URL</strong> e a <strong>Anon Key</strong> do Supabase.</div>
          <div class="form-group" style="margin-bottom:12px"><label class="form-label">Project URL</label><input class="form-input" id="setup-url" placeholder="https://xxxx.supabase.co"></div>
          <div class="form-group" style="margin-bottom:0"><label class="form-label">Anon Key</label><input class="form-input" id="setup-key" placeholder="eyJhbGciOiJIUzI1NiIs..."></div>
        </div>
      </div>
      <button class="btn-submit" onclick="saveSetup('viewer')" style="margin-top:0">Entrar como Visualizador ğŸ‘ï¸</button>`;
  }
}

async function saveSetup(role) {
  const url = document.getElementById('setup-url')?.value.trim();
  const key = document.getElementById('setup-key')?.value.trim();
  if(!url || !key) { showToast('âš ï¸ Preencha URL e chave'); return; }

  // Test connection
  setSyncStatus('syncing', 'testando...');
  try {
    const r = await sbFetch(`${url}/rest/v1/accounts?limit=1`, key);
    if(!r.ok && r.status !== 406) throw new Error(`status ${r.status}`);
  } catch(e) {
    showToast('âŒ NÃ£o foi possÃ­vel conectar. Verifique URL e chave.');
    setSyncStatus('error', 'erro de conexÃ£o');
    return;
  }

  SUPABASE_URL = url; SUPABASE_KEY = key; USER_ROLE = role;
  localStorage.setItem('sb-url', url);
  localStorage.setItem('sb-key', key);
  localStorage.setItem('user-role', role);
  document.getElementById('setup-screen').style.display = 'none';
  applyRole();
  await loadFromSupabase();
  startAutoSync();
  showToast(role==='admin' ? 'ğŸ‘‘ Conectado como Admin!' : 'ğŸ‘ï¸ Conectado como Visualizador!');
}

function applyRole() {
  const isAdmin = USER_ROLE === 'admin';
  document.getElementById('role-badge').textContent = isAdmin ? 'ğŸ‘‘ Admin' : 'ğŸ‘ï¸ Viewer';
  document.getElementById('role-badge').className = `role-badge ${isAdmin?'admin':'viewer'}`;
  document.getElementById('btn-add-header').style.display = isAdmin ? '' : 'none';
  document.getElementById('btn-import-header').style.display = isAdmin ? '' : 'none';
}

function resetSetup() {
  localStorage.removeItem('sb-url'); localStorage.removeItem('sb-key'); localStorage.removeItem('user-role');
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sbFetch(url, key, options={}) {
  return fetch(url, {
    ...options,
    headers: {
      'apikey': key || SUPABASE_KEY,
      'Authorization': `Bearer ${key || SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal',
      ...(options.headers||{})
    }
  });
}

async function loadFromSupabase() {
  setSyncStatus('syncing','sincronizando...');
  try {
    const r = await sbFetch(`${SUPABASE_URL}/rest/v1/accounts?select=*&order=updated_at.desc`);
    if(!r.ok) throw new Error(await r.text());
    const rows = await r.json();
    accounts = rows.map(row => row.data);
    renderCards();
    setSyncStatus('synced', `${accounts.length} contas`);
  } catch(e) {
    setSyncStatus('error','erro ao sincronizar');
    // Fallback to localStorage
    const local = localStorage.getItem('radar-accounts');
    if(local) accounts = JSON.parse(local);
    renderCards();
  }
}

async function saveToSupabase(account) {
  setSyncStatus('syncing','salvando...');
  try {
    const r = await sbFetch(`${SUPABASE_URL}/rest/v1/accounts`, SUPABASE_KEY, {
      method: 'POST',
      headers: {'Prefer':'resolution=merge-duplicates,return=minimal'},
      body: JSON.stringify({id: String(account.id), data: account, updated_at: new Date().toISOString()})
    });
    if(!r.ok) throw new Error(await r.text());
    setSyncStatus('synced', `${accounts.length} contas`);
  } catch(e) {
    setSyncStatus('error','erro ao salvar');
    // Fallback
    localStorage.setItem('radar-accounts', JSON.stringify(accounts));
  }
}

async function deleteFromSupabase(id) {
  try {
    await sbFetch(`${SUPABASE_URL}/rest/v1/accounts?id=eq.${id}`, SUPABASE_KEY, {method:'DELETE'});
  } catch(e) {}
}

function startAutoSync() {
  if(syncInterval) clearInterval(syncInterval);
  syncInterval = setInterval(loadFromSupabase, 30000); // refresh every 30s
}

function setSyncStatus(state, msg) {
  const el = document.getElementById('sync-indicator');
  el.className = `sync-indicator ${state}`;
  const icons = {syncing:'â†»', synced:'â¬¤', error:'âš '};
  el.textContent = `${icons[state]} ${msg}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” check if already configured
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(SUPABASE_URL && SUPABASE_KEY && USER_ROLE) {
  document.getElementById('setup-screen').style.display = 'none';
  applyRole();
  loadFromSupabase();
  startAutoSync();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getInitials(n){return n.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();}
function priorityOrder(p){return p==='hot'?0:p==='warm'?1:2;}
function getSorted(list){return[...list].sort((a,b)=>{if(currentSort==='priority')return priorityOrder(a.priority)-priorityOrder(b.priority);if(currentSort==='name')return a.name.localeCompare(b.name);if(currentSort==='signals')return b.signals.length-a.signals.length;if(currentSort==='recent')return b.createdAt-a.createdAt;});}
function getFiltered(){return accounts.filter(a=>{if(currentFilter!=='all'&&a.priority!==currentFilter)return false;if(currentSegFilter!=='all'&&a.segment!==currentSegFilter)return false;if(searchQuery&&!a.name.toLowerCase().includes(searchQuery.toLowerCase()))return false;if(currentSignalFilter&&!a.signals.some(s=>s.type===currentSignalFilter))return false;return true;});}

function renderCards(){
  const grid=document.getElementById('cards-grid');
  const empty=document.getElementById('empty-state');
  const filtered=getSorted(getFiltered());
  updateStats();updateCounts();
  if(filtered.length===0){grid.innerHTML='';empty.classList.add('visible');return;}
  empty.classList.remove('visible');
  const isAdmin = USER_ROLE==='admin';
  const signalIcons={expansion:'ğŸ—ï¸',news:'ğŸ“°',competitor:'âš”ï¸'};
  const signalClass={expansion:'expansion',news:'news',competitor:'competitor'};
  grid.innerHTML=filtered.map((a,i)=>{
    const color=a.color||COLORS[i%COLORS.length];
    const badgeLabel=a.priority==='hot'?'ğŸ”´ Quente':a.priority==='warm'?'ğŸŸ¡ Morno':'ğŸ”µ Frio';
    const topSignals=a.signals.slice(0,2).map(s=>`<div class="signal-item ${signalClass[s.type]}"><div class="signal-icon">${signalIcons[s.type]}</div><div class="signal-text">${s.text}</div><div class="signal-time">${s.time}</div></div>`).join('');
    return `<div class="account-card ${a.priority}" style="animation-delay:${i*.05}s" id="card-${a.id}">
      <div class="card-top">
        <div class="company-info">
          <div class="company-avatar" style="background:${color[1]};color:${color[0]}">${getInitials(a.name)}</div>
          <div><div class="company-name">${a.name}</div><div class="company-segment">${a.segment||''}${a.stores?' Â· '+Number(a.stores).toLocaleString()+' lojas':''}</div></div>
        </div>
        <div class="priority-badge badge-${a.priority}">${badgeLabel}</div>
      </div>
      <div class="signals">${topSignals}</div>
      <div id="ai-panel-${a.id}" class="ai-panel"></div>
      <div class="card-footer">
        <div class="signal-count"><span>${a.signals.length}</span> sinal${a.signals.length!==1?'is':''}</div>
        <div class="card-actions">
          <button class="btn-ai" id="btn-ai-${a.id}" onclick="generateSummary(${JSON.stringify(a.id)})">âœ¨ Resumo IA</button>
          ${isAdmin?`<button class="btn-action" onclick="addSignalModal(${JSON.stringify(a.id)})">+ Sinal</button>`:''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function updateStats(){
  document.getElementById('total-count').textContent=accounts.length;
  document.getElementById('hot-count').textContent=accounts.filter(a=>a.priority==='hot').length;
  document.getElementById('signal-count').textContent=accounts.reduce((s,a)=>s+a.signals.filter(sig=>sig.time.includes('h')||sig.time==='agora'||sig.time==='IA').length,0);
  document.getElementById('opp-count').textContent=accounts.filter(a=>a.priority!=='cold').length;
}
function updateCounts(){
  document.getElementById('count-all').textContent=accounts.length;
  document.getElementById('count-hot').textContent=accounts.filter(a=>a.priority==='hot').length;
  document.getElementById('count-warm').textContent=accounts.filter(a=>a.priority==='warm').length;
  document.getElementById('count-cold').textContent=accounts.filter(a=>a.priority==='cold').length;
}
function setFilter(f,btn){currentFilter=f;currentSignalFilter=null;currentSegFilter='all';document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');const labels={all:'Todas as Contas',hot:'Contas Quentes',warm:'Contas Mornas',cold:'Contas Frias'};document.getElementById('section-title').textContent=labels[f]||'Contas';renderCards();}
function setSignalFilter(f,btn){currentSignalFilter=currentSignalFilter===f?null:f;document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));if(currentSignalFilter)btn.classList.add('active');renderCards();}
function setSegFilter(f,btn){currentSegFilter=f;document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderCards();}
function filterCards(){searchQuery=document.getElementById('search-input').value;renderCards();}
function sortCards(val){currentSort=val;renderCards();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD / EDIT ACCOUNT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let addSignalFor=null;
function openModal(){if(USER_ROLE!=='admin')return;addSignalFor=null;document.getElementById('modal-title').textContent='Nova Conta';document.getElementById('modal-overlay').classList.add('open');}
function addSignalModal(id){if(USER_ROLE!=='admin')return;addSignalFor=id;const acc=accounts.find(a=>a.id===id);document.getElementById('modal-title').textContent=`+ Sinal Â· ${acc.name}`;document.getElementById('f-name').value=acc.name;document.getElementById('f-segment').value=acc.segment||'';document.getElementById('f-priority').value=acc.priority;document.getElementById('f-stores').value=acc.stores||'';document.getElementById('f-signal-text').value='';document.getElementById('modal-overlay').classList.add('open');}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');addSignalFor=null;document.getElementById('autofill-status').style.display='none';window._extraSignals=null;['f-name','f-segment','f-priority','f-stores','f-signal-text'].forEach(id=>{const el=document.getElementById(id);if(el.tagName==='SELECT')el.selectedIndex=0;else el.value=''});}
function closeModalOnOverlay(e){if(e.target===document.getElementById('modal-overlay'))closeModal();}

async function addAccount(){
  if(USER_ROLE!=='admin')return;
  const name=document.getElementById('f-name').value.trim();
  const segment=document.getElementById('f-segment').value;
  const priority=document.getElementById('f-priority').value;
  const stores=document.getElementById('f-stores').value;
  const signalText=document.getElementById('f-signal-text').value.trim();
  const signalType=document.getElementById('f-signal-type').value;
  if(!name){showToast('âš ï¸ Informe o nome da empresa');return;}

  if(addSignalFor!==null){
    const acc=accounts.find(a=>a.id===addSignalFor);
    acc.priority=priority;
    if(signalText)acc.signals.unshift({type:signalType,text:signalText,time:'agora'});
    await saveToSupabase(acc);
    showToast('âœ… Sinal adicionado!');
  } else {
    const signals=signalText?[{type:signalType,text:signalText,time:'agora'}]:[];
    if(window._extraSignals){window._extraSignals.forEach(s=>signals.push({type:s.type,text:s.text,time:'IA'}));window._extraSignals=null;}
    const acc={id:Date.now(),name,segment,priority,stores:stores||null,color:COLORS[accounts.length%COLORS.length],signals,createdAt:Date.now()};
    accounts.push(acc);
    await saveToSupabase(acc);
    showToast('âœ… Conta adicionada!');
  }
  closeModal();renderCards();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openApiKeyModal(){const key=localStorage.getItem('claude-api-key')||'';document.getElementById('f-apikey').value=key;document.getElementById('apikey-overlay').classList.add('open');}
function closeApiKeyModal(){document.getElementById('apikey-overlay').classList.remove('open');}
function closeApiKeyOnOverlay(e){if(e.target===document.getElementById('apikey-overlay'))closeApiKeyModal();}
function saveApiKey(){const key=document.getElementById('f-apikey').value.trim();if(!key){showToast('âš ï¸ Insira uma chave vÃ¡lida');return;}localStorage.setItem('claude-api-key',key);showToast('âœ… Chave salva!');closeApiKeyModal();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUDE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callClaude(prompt,maxTokens=500){
  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{'Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true','x-api-key':localStorage.getItem('claude-api-key')||'','anthropic-version':'2023-06-01'},
    body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:maxTokens,messages:[{role:'user',content:prompt}]})
  });
  if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.error?.message||`Erro ${res.status}`);}
  const data=await res.json();
  return data.content[0].text;
}

async function generateSummary(id){
  const apiKey=localStorage.getItem('claude-api-key');
  if(!apiKey){showToast('âš ï¸ Configure sua chave API primeiro');openApiKeyModal();return;}
  const acc=accounts.find(a=>a.id===id);
  const panel=document.getElementById(`ai-panel-${id}`);
  const btn=document.getElementById(`btn-ai-${id}`);
  if(panel.classList.contains('visible')){panel.classList.remove('visible');return;}
  btn.classList.add('loading');btn.textContent='â³';
  panel.innerHTML=`<div class="ai-panel-header"><div class="ai-label">âœ¨ AnÃ¡lise IA</div></div><div class="ai-text ai-typing" id="ai-text-${id}"></div>`;
  panel.classList.add('visible');
  const signalLabels={expansion:'ExpansÃ£o',news:'NotÃ­cia',competitor:'Concorrente'};
  const signalsList=acc.signals.map(s=>`â€¢ [${signalLabels[s.type]}] ${s.text}`).join('\n')||'â€¢ Sem sinais';
  try{
    const text=await callClaude(`VocÃª Ã© assistente de vendas B2B para tech de varejo. Gere briefing executivo CONCISO (mÃ¡x 120 palavras) em portuguÃªs:

Empresa: ${acc.name} | Segmento: ${acc.segment} | Lojas: ${acc.stores||'?'} | Prioridade: ${acc.priority==='hot'?'QUENTE':acc.priority==='warm'?'MORNO':'FRIO'}
Sinais: ${signalsList}

Responda em 3 partes:
ğŸ¯ MOMENTO: situaÃ§Ã£o atual
ğŸ’¡ OPORTUNIDADE: como posicionar minha soluÃ§Ã£o
ğŸš€ AÃ‡ÃƒO: prÃ³ximo passo concreto`,400);
    const textEl=document.getElementById(`ai-text-${id}`);
    if(textEl){textEl.classList.remove('ai-typing');let i=0;textEl.textContent='';const iv=setInterval(()=>{if(i<text.length){textEl.textContent+=text[i];i++;}else clearInterval(iv);},8);}
    panel.querySelector('.ai-panel-header').innerHTML=`<div class="ai-label">âœ¨ AnÃ¡lise IA</div><button class="ai-close" onclick="document.getElementById('ai-panel-${id}').classList.remove('visible')">âœ•</button>`;
  }catch(err){
    panel.innerHTML=`<div class="ai-panel-header"><div class="ai-label">âŒ Erro</div></div><div class="ai-text" style="color:var(--hot)">${err.message.includes('401')?'Chave invÃ¡lida.':err.message}</div>`;
  }
  btn.classList.remove('loading');btn.innerHTML='âœ¨ Resumo IA';
}

async function autofillWithAI(){
  const name=document.getElementById('f-name').value.trim();
  if(!name){showToast('âš ï¸ Digite o nome da empresa primeiro');return;}
  const apiKey=localStorage.getItem('claude-api-key');
  if(!apiKey){showToast('âš ï¸ Configure sua chave API primeiro');openApiKeyModal();return;}
  const btn=document.getElementById('btn-autofill');
  const status=document.getElementById('autofill-status');
  btn.textContent='â³';btn.disabled=true;
  status.style.display='flex';
  document.getElementById('autofill-status-text').textContent='ğŸ” Pesquisando '+name+'...';
  try{
    const raw=await callClaude(`Especialista em varejo BR. Sobre "${name}", retorne APENAS JSON vÃ¡lido sem markdown:
{"segment":"Supermercados|FarmÃ¡cias|Moda|EletrÃ´nicos|Home Center|Outros","stores":nÃºmero_ou_null,"priority":"hot|warm|cold","priority_reason":"frase curta","signals":[{"type":"expansion|news|competitor","text":"sinal relevante mÃ¡x 12 palavras"},{"type":"...","text":"..."},{"type":"...","text":"..."}]}`,600);
    const info=JSON.parse(raw.replace(/```json|```/g,'').trim());
    if(info.segment){const s=document.getElementById('f-segment');for(let o of s.options)if(o.value===info.segment){s.value=info.segment;break;}}
    if(info.stores)document.getElementById('f-stores').value=info.stores;
    if(info.priority)document.getElementById('f-priority').value=info.priority;
    if(info.signals&&info.signals.length>0){document.getElementById('f-signal-text').value=info.signals[0].text;document.getElementById('f-signal-type').value=info.signals[0].type;}
    window._extraSignals=(info.signals||[]).slice(1);
    status.innerHTML=`<span style="color:var(--accent)">âœ… Preenchido${info.priority_reason?' Â· '+info.priority_reason:''}</span>`;
    showToast('âœ… Dados preenchidos!');
  }catch(e){
    status.innerHTML=`<span style="color:var(--hot)">âŒ NÃ£o foi possÃ­vel buscar. Preencha manualmente.</span>`;
  }
  btn.textContent='âœ¨ IA';btn.disabled=false;
}

async function enrichImportedAccounts(newAccounts){
  const apiKey=localStorage.getItem('claude-api-key');
  if(!apiKey||newAccounts.length===0)return;
  showToast(`âœ¨ Enriquecendo ${newAccounts.length} contas com IA...`);
  const batches=[];
  for(let i=0;i<newAccounts.length;i+=5)batches.push(newAccounts.slice(i,i+5));
  for(const batch of batches){
    const names=batch.map(a=>a.name).join(', ');
    try{
      const raw=await callClaude(`Especialista varejo BR. Para cada empresa, retorne APENAS JSON:
Empresas: ${names}
{"companies":[{"name":"nome exato","stores":nÃºmero_ou_null,"priority":"hot|warm|cold","signal_text":"sinal mÃ¡x 12 palavras","signal_type":"expansion|news|competitor"}]}`,800);
      const result=JSON.parse(raw.replace(/```json|```/g,'').trim());
      const saves=[];
      result.companies.forEach(info=>{
        const acc=accounts.find(a=>a.name.toLowerCase()===info.name.toLowerCase());
        if(!acc)return;
        if(info.stores&&!acc.stores)acc.stores=info.stores;
        if(info.priority&&acc.priority==='cold')acc.priority=info.priority;
        if(info.signal_text&&acc.signals.length===0)acc.signals.push({type:info.signal_type||'news',text:info.signal_text,time:'IA'});
        saves.push(saveToSupabase(acc));
      });
      await Promise.all(saves);
    }catch(e){}
  }
  renderCards();showToast('âœ… Contas enriquecidas!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportToExcel(){
  const pLabel={hot:'Quente',warm:'Morno',cold:'Frio'};
  const sLabel={expansion:'ExpansÃ£o',news:'NotÃ­cia',competitor:'Concorrente'};
  const resumo=[['Empresa','Segmento','Prioridade','NÂº Lojas','Qtd. Sinais','Sinais','Cadastro']];
  accounts.forEach(a=>resumo.push([a.name,a.segment||'-',pLabel[a.priority],a.stores||'-',a.signals.length,a.signals.map(s=>s.text).join(' | '),new Date(a.createdAt).toLocaleDateString('pt-BR')]));
  const sinais=[['Empresa','Segmento','Prioridade','Tipo','DescriÃ§Ã£o','Quando']];
  accounts.forEach(a=>a.signals.forEach(s=>sinais.push([a.name,a.segment||'-',pLabel[a.priority],sLabel[s.type]||s.type,s.text,s.time])));
  const quentes=[['Empresa','Segmento','NÂº Lojas','Ãšltimo Sinal','Tipo']];
  accounts.filter(a=>a.priority==='hot').forEach(a=>{const last=a.signals[0];quentes.push([a.name,a.segment||'-',a.stores||'-',last?last.text:'-',last?sLabel[last.type]:'-']);});
  const wb=XLSX.utils.book_new();
  const ws1=XLSX.utils.aoa_to_sheet(resumo);ws1['!cols']=[{wch:25},{wch:15},{wch:10},{wch:10},{wch:12},{wch:60},{wch:15}];
  const ws2=XLSX.utils.aoa_to_sheet(sinais);ws2['!cols']=[{wch:25},{wch:15},{wch:10},{wch:15},{wch:60},{wch:12}];
  const ws3=XLSX.utils.aoa_to_sheet(quentes);ws3['!cols']=[{wch:25},{wch:15},{wch:10},{wch:60},{wch:15}];
  XLSX.utils.book_append_sheet(wb,ws1,'Radar Completo');
  XLSX.utils.book_append_sheet(wb,ws2,'Todos os Sinais');
  XLSX.utils.book_append_sheet(wb,ws3,'Contas Quentes');
  XLSX.writeFile(wb,`radar-${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.xlsx`);
  showToast('ğŸ“Š Excel exportado!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let importPreviewData=[];
function openImportModal(){if(USER_ROLE!=='admin')return;resetImport();document.getElementById('import-overlay').classList.add('open');}
function closeImportModal(){document.getElementById('import-overlay').classList.remove('open');}
function closeImportOnOverlay(e){if(e.target===document.getElementById('import-overlay'))closeImportModal();}
function onDragOver(e){e.preventDefault();document.getElementById('drop-zone').classList.add('drag-over');}
function onDragLeave(){document.getElementById('drop-zone').classList.remove('drag-over');}
function onDrop(e){e.preventDefault();document.getElementById('drop-zone').classList.remove('drag-over');const file=e.dataTransfer.files[0];if(file)processFile(file);}
function handleFile(e){const file=e.target.files[0];if(file)processFile(file);}

function processFile(file){
  const reader=new FileReader();
  const isCsv=file.name.endsWith('.csv');
  reader.onload=function(e){
    let rows=[];
    if(isCsv){const text=e.target.result;rows=text.split('\n').map(r=>r.split(/[,;]/).map(c=>c.trim().replace(/^"|"$/g,'')));}
    else{const wb=XLSX.read(e.target.result,{type:'binary'});const ws=wb.Sheets[wb.SheetNames[0]];rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});}
    parseImportRows(rows);
  };
  if(isCsv)reader.readAsText(file,'UTF-8');else reader.readAsBinaryString(file);
}

function parseImportRows(rows){
  if(rows.length<2){showToast('âš ï¸ Arquivo vazio');return;}
  const headers=rows[0].map(h=>String(h).toLowerCase().trim());
  const colIdx={
    nome:headers.findIndex(h=>h.includes('nome')||h.includes('empresa')),
    segmento:headers.findIndex(h=>h.includes('seg')),
    prioridade:headers.findIndex(h=>h.includes('prior')||h.includes('status')),
    lojas:headers.findIndex(h=>h.includes('loja')||h.includes('store')),
    sinal:headers.findIndex(h=>h.includes('sinal')||h.includes('obs')),
    tipoSinal:headers.findIndex(h=>h.includes('tipo')||h.includes('type'))
  };
  if(colIdx.nome===-1){showToast('âš ï¸ Coluna "Nome" nÃ£o encontrada');return;}
  const pMap={'quente':'hot','hot':'hot','morno':'warm','warm':'warm','frio':'cold','cold':'cold','':'cold'};
  const tMap={'expansÃ£o':'expansion','expansao':'expansion','expansion':'expansion','notÃ­cia':'news','noticia':'news','news':'news','concorrente':'competitor','competitor':'competitor','':'expansion'};
  importPreviewData=rows.slice(1).filter(r=>r[colIdx.nome]?.toString().trim()).map(r=>{
    const get=(i)=>i>=0?String(r[i]||'').trim():'';
    return{name:get(colIdx.nome),segment:get(colIdx.segmento)||'Outros',priority:pMap[get(colIdx.prioridade).toLowerCase()]||'cold',stores:get(colIdx.lojas)||null,signalText:get(colIdx.sinal),signalType:tMap[get(colIdx.tipoSinal).toLowerCase()]||'expansion'};
  });
  if(importPreviewData.length===0){showToast('âš ï¸ Nenhuma conta vÃ¡lida encontrada');return;}
  showImportPreview();
}

function showImportPreview(){
  document.getElementById('import-step-1').style.display='none';
  document.getElementById('import-step-2').style.display='block';
  const existing=accounts.map(a=>a.name.toLowerCase());
  const newOnes=importPreviewData.filter(r=>!existing.includes(r.name.toLowerCase()));
  document.getElementById('import-summary').innerHTML=`
    <div class="import-stat"><div class="import-stat-val">${importPreviewData.length}</div><div class="import-stat-label">No arquivo</div></div>
    <div class="import-stat"><div class="import-stat-val" style="color:var(--accent)">${newOnes.length}</div><div class="import-stat-label">Novas</div></div>
    <div class="import-stat"><div class="import-stat-val" style="color:var(--warm)">${importPreviewData.length-newOnes.length}</div><div class="import-stat-label">Duplicadas</div></div>`;
  const pLabel={hot:'ğŸ”´ Quente',warm:'ğŸŸ¡ Morno',cold:'ğŸ”µ Frio'};
  document.getElementById('preview-table').innerHTML=`<thead><tr><th>Empresa</th><th>Segmento</th><th>Prioridade</th><th>Lojas</th></tr></thead><tbody>${importPreviewData.slice(0,8).map(r=>`<tr><td>${r.name}</td><td>${r.segment}</td><td>${pLabel[r.priority]}</td><td>${r.stores||'-'}</td></tr>`).join('')}${importPreviewData.length>8?`<tr><td colspan="4" style="text-align:center;color:var(--muted)">... e mais ${importPreviewData.length-8}</td></tr>`:''}</tbody>`;
}

async function confirmImport(){
  const existing=accounts.map(a=>a.name.toLowerCase());
  let added=0;const newAccounts=[];
  importPreviewData.forEach(r=>{
    if(existing.includes(r.name.toLowerCase()))return;
    const acc={id:Date.now()+Math.random(),name:r.name,segment:r.segment,priority:r.priority,stores:r.stores||null,color:COLORS[accounts.length%COLORS.length],signals:r.signalText?[{type:r.signalType,text:r.signalText,time:'importado'}]:[],createdAt:Date.now()};
    accounts.push(acc);newAccounts.push(acc);added++;
  });
  closeImportModal();renderCards();
  showToast(`âœ… ${added} conta${added!==1?'s':''} importada${added!==1?'s':''}!`);
  // Save all to Supabase
  await Promise.all(newAccounts.map(a=>saveToSupabase(a)));
  if(localStorage.getItem('claude-api-key')&&newAccounts.length>0) setTimeout(()=>enrichImportedAccounts(newAccounts),1000);
}

function resetImport(){importPreviewData=[];document.getElementById('import-step-1').style.display='block';document.getElementById('import-step-2').style.display='none';document.getElementById('file-input').value='';}

function downloadTemplate(){
  const ws=XLSX.utils.aoa_to_sheet([['Nome','Segmento','Prioridade','Lojas','Sinal','Tipo Sinal'],['Grupo Exemplo','Supermercados','quente','120','Inaugurou 5 lojas em SP','expansÃ£o'],['FarmÃ¡cia Modelo','FarmÃ¡cias','morno','45','',''],['Loja Teste','Moda','frio','12','Nova diretoria assumiu','notÃ­cia']]);
  ws['!cols']=[{wch:25},{wch:15},{wch:12},{wch:8},{wch:40},{wch:15}];
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Contas');
  XLSX.writeFile(wb,'modelo-importacao-radar.xlsx');showToast('â¬‡ï¸ Modelo baixado!');
}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
</script>
</body>
</html>
